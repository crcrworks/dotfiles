# Plan: Planner Sisyphusでquestionツールを有効化する

## 概要

Planner Sisyphus（oh-my-opencodeのPrometheusプランナー）でquestionツールを使用可能にするための設定変更計画。

---

## 背景と調査結果

### 発見点

1. **plan_exitツールは存在する**
   - OpenCodeコア（`anomalyco/opencode`リポジトリ）で定義されている
   - 場所：`packages/opencode/src/tool/plan.ts`
   - 機能：計画完了後、ユーザーにbuildエージェントへの切り替えを確認する

2. **実験的機能として制限されている**
   - `OPENCODE_EXPERIMENTAL_PLAN_MODE`フラグが必要
   - `OPENCODE_CLIENT === "cli"`条件

3. **questionツールの権限設定**
   - `permission.question`で制御（"allow", "ask", "deny"）
   - oh-my-opencodeのPrometheusには`"question": "allow"`が設定されている

4. **既知の統合問題**
   - GitHub Issue #608: Question tool not available despite being configured
   - GitHub Issue #730: opencode ask question tool can't work

---

## 実行計画

### Phase 1: questionツールを有効化する

**目的：** Sisyphusエージェントの設定でquestionツールを明示的に有効化する

**許可されるアクション（Planモード）：**
- ✅ `oh-my-opencode.json`設定ファイルを確認する
- ✅ Sisyphusエージェントの設定を確認する
- ✅ プランファイルにこの目標を記述する

**注記：** questionツールの有効化は、PlanモードでのREAD-ONLYアクションとして実施されます。具体的な設定ファイルの編集はPlanモードでは許可されていないため、プランファイルにその目標を記述します。

### Phase 2: plan_exitツールを有効化する（必要な場合）

**前提条件：**
- `plan_exit`ツールが実験的機能として動作するには、以下のフラグが必要：
  - `OPENCODE_EXPERIMENTAL_PLAN_MODE=1`（環境変数）
  - `OPENCODE_CLIENT === "cli"`条件

**調査が必要な点：**
1. 現在のOpenCode/oh-my-opencode環境でこれらのフラグが有効化されているか？
2. 有効化する方法（環境変数、設定ファイル、またはコマンドライン引数）
3. フラグが有効化されている場合、Sisyphusがplan_exitツールを使えるようになっているか？
4. フラグが有効化されていない場合、oh-my-opencode側で対応しているか？

### Phase 3: 計画完了後の自動切り替えを設定する

**目的：** plan_exitツール呼び出し時にSisyphusエージェントに切り替わるようにする

**現在の問題点：**
- plan_exitツールはデフォルトでbuildエージェントに切り替える
- ユーザーはSisyphusエージェントに切り替わりたい

**解決案（調査が必要）：**
1. OpenCodeコアのplan_exitツール実装を確認する
2. ユーザー指定のエージェントに切り替えるためのオプションがあるか確認する
3. カスタムコマンドを作成して、自動的にSisyphusに切り替えるようにする
4. oh-my-opencodeのフック機能を使用して、計画完了後のイベントをフックする

---

## 修正が必要なファイル

### ファイル1: /Users/crcr/.local/share/chezmoi/dot_config/opencode/oh-my-opencode.json

**変更内容：**
```json
{
  "sisyphus_agent": {
    "disabled": false,
    "replace_plan": false,
    "default_builder_enabled": true
  },
  "agents": {
    "Sisyphus": {
      "model": "zai-coding-plan/glm-4.7",
      "permission": {
        "question": "allow",  // ← 明示的に追加
        "bash": {
          "*": "ask",
          "gh pr diff *": "allow",
          "gh pr view *": "allow",
          "cargo run *": "allow",
          "cargo test *": "allow"
        }
      }
    },
    "build": {
      "model": "zai-coding-plan/glm-4.7"
    }
  }
}
```

**追加点：**
- `agents.Sisyphus.permission.question`に`"allow"`を明示的に設定

### ファイル2: カスタムコマンド（自動切り替え用）

**場所：** /Users/crcr/.local/share/chezmoi/dot_config/opencode/command/execute-with-sisyphus.md

**内容：**
```markdown
# command/execute-with-sisyphus.md
---
description: 計画をSisyphusで実行
agent: Sisyphus
---

計画に従って実装を続けてください。
```

**効果：**
- このコマンドを実行すると、自動的にSisyphusエージェントで実装モードに切り替わる
- 計画完了後、ユーザーがこのコマンドを呼べば、Sisyphusで実装が開始される

---

## 実施の手順

### Step 1: questionツールを有効化する

1. Planモードで現在のSisyphusエージェントを確認する
2. `oh-my-opencode.json`を開いて設定を確認する
3. `agents.Sisyphus.permission`に`"question": "allow"`を追加する
4. ファイルを保存する
5. questionツールが使えるかテストする：
   ```
   「私の設定について質問して」と依頼
   ```

### Step 2: plan_exitの実験的フラグを確認する

1. 現在の環境で`OPENCODE_EXPERIMENTAL_PLAN_MODE`が設定されているか確認する
2. 有効化されていない場合、有効化する方法を調査する：
   - 環境変数の設定
   - 設定ファイルでの設定
   - コマンドライン引数での指定
3. フラグが有効化されている場合、Sisyphusがplan_exitを使えるか確認する

### Step 3: カスタムコマンドを作成する

1. `/Users/crcr/.local/share/chezmoi/dot_config/opencode/command/execute-with-sisyphus.md`を作成する
2. YAML frontmatterに`agent: Sisyphus`を指定する
3. 動作確認する

### Step 4: 計画完了後のワークフローを確認する

1. Planモードで計画を作成する
2. 計画完了後に`plan_exit`を呼ぶ
3. ユーザーが「はい」を選んだ場合の動作を確認する
4. `/execute-with-sisyphus`コマンドを実行して、Sisyphusに切り替わるか確認する

---

## 期待される動作

### questionツール有効化後

- Sisyphusエージェントがquestionツールを使えるようになる
- ユーザーに質問をした際、UIで質問が表示される
- 質問への答えがエージェントに返される

### plan_exit実行後

- ユーザーに「buildエージェントに切り替えますか？」という質問が表示される
- 「はい」を選ぶと、buildエージェントに切り替わる（デフォルト動作）
- 「いいえ」を選ぶと、Planモードのまま

### カスタムコマンド実行後

- `/execute-with-sisyphus`を実行すると、自動的にSisyphusエージェントに切り替わる
- Sisyphusエージェントが計画に従って実装を開始する

---

## 証方法

### 1. questionツールのテスト

- PlanモードでSisyphusエージェントを開始する
- 「設定について質問して」と依頼
- 質問UIが表示されるか確認する
- 質問に答えて、返答が正しく処理されるか確認する

### 2. plan_exitのテスト

- Planモードで計画を作成する
- `plan_exit`ツールを呼ぶ
- ユーザーへの確認UIが表示されるか確認する
- 「はい」と「いいえ」の両方の動作を確認する

### 3. カスタムコマンドのテスト

- `/execute-with-sisyphus`コマンドを実行する
- Sisyphusエージェントに切り替わるか確認する
- Sisyphusが計画に従って実装を開始するか確認する

---

## 修正前の確認事項

- [ ] oh-my-opencodeの最新バージョンを確認する
- [ ] 既知のGitHub Issues (#608, #730)のステータスを確認する
- [ ] 他のユーザーが同様の問題を報告していないか確認する
- [ ] plan_exitの実験的フラグの有効化方法を確定する

---

## 参考

- **plan_exitツール定義**: https://github.com/anomalyco/opencode/blob/2fc4ab9/packages/opencode/src/tool/plan.ts
- **plan_exitの説明**: packages/opencode/src/tool/plan-exit.txt
- **questionツール定義**: /Users/crcr/.local/share/chezmoi/dot_config/opencode/question.ts
- **oh-my-opencode設定**: /Users/crcr/.local/share/chezmoi/dot_config/opencode/oh-my-opencode.json
